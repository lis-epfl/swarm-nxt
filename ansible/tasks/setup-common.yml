- name: Check Internet connectivity (Ping)
  block:
    - name: Ping Google DNS
      ansible.builtin.command: ping -c 1 -W 2 8.8.8.8
      register: ping_check
      changed_when: false
      # 0 means success (reachable), anything else is failure
      failed_when: ping_check.rc != 0
      retries: 1
      delay: 3

  rescue:
    - name: Fail if Internet is not reachable
      ansible.builtin.fail:
        msg: "No Internet connectivity (Ping 8.8.8.8 failed). Please check network settings."

- name: Force sync date from Google HTTP Header
  become: true
  ansible.builtin.shell: |
    # 1. Get headers from google
    # 2. Find the Date line
    # 3. Remove everything up to 'Date: ' (handling variable whitespace)
    # 4. Take the first result only (in case of redirects)
    NEW_DATE=$(wget --no-check-certificate -qSO- --max-redirect=0 google.com 2>&1 | grep "Date:" | sed 's/.*Date: //g' | head -n 1)
    
    # Set the date
    date -s "$NEW_DATE"
  args:
    executable: /bin/bash

- name: Check kernel, patch if needed
  ansible.builtin.include_tasks: "patch-kernel.yml"       
- name: Add Docker apt repository
  block:
    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
        state: present
        update_cache: yes
    
    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
    
    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
    
    - name: Add Docker repository
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/docker.list
        line: "deb [arch=arm64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        create: yes
    
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

- name: Ensure apt packages are installed
  ansible.builtin.apt: 
    name: 
      - python3-pip
      - python3-loguru 
      - python3-yaml
      - htop 
      - sysstat
      - chrony
      - docker-ce=5:27.5*
      - docker-ce-cli=5:27.5*
      - libopencv-dev
      - libusb-1.0-0-dev

    state: present
    allow_downgrade: true

- name: Install nvidia toolkit
  ansible.builtin.pip:
    name: 
      - nvidia-jetpack

- name: Jetson Stats
  ansible.builtin.pip:
    name: 
      - jetson-stats

- name: Install ONNX Runtime (C++ Dev Files)
    become: true
    block:
      # 1. Install the Python package to get the pre-compiled .so libraries
      - name: Install onnxruntime-gpu pip package (JetPack 6)
        pip:
          name: onnxruntime-gpu
          extra_args: "--index-url https://pypi.jetson-ai-lab.io/jp6/cu126 --upgrade"
          executable: pip3

      # 2. Find where pip installed it
      - name: Find onnxruntime location
        shell: pip3 show onnxruntime-gpu | grep Location | cut -d " " -f 2
        register: ort_pip_loc
        changed_when: false

      # 3. Symlink the shared libraries to /usr/local/lib so CMake finds them
      - name: Symlink ONNX Runtime libraries
        shell: |
          # Link versioned libs
          ln -sf {{ ort_pip_loc.stdout }}/onnxruntime/capi/libonnxruntime.so.* /usr/local/lib/
          ln -sf {{ ort_pip_loc.stdout }}/onnxruntime/capi/libonnxruntime_providers_*.so /usr/local/lib/
          
          # Link the main .so generic name
          ORT_SO=$(find {{ ort_pip_loc.stdout }}/onnxruntime/capi -name "libonnxruntime.so.*" | head -n 1)
          ln -sf $ORT_SO /usr/local/lib/libonnxruntime.so
          
          # Update library cache
          ldconfig

      # 4. Download headers from source (since pip package doesn't have them)
      - name: Download and Install ONNX Runtime Headers
        shell: |
          ORT_VER=v1.17.0
          # Only run if we haven't already installed the headers
          if [ ! -f /usr/local/include/onnxruntime_cxx_api.h ]; then
            # Download source code for headers
            wget https://github.com/microsoft/onnxruntime/archive/refs/tags/${ORT_VER}.tar.gz -O /tmp/ort.tar.gz
            tar -xf /tmp/ort.tar.gz -C /tmp/
            
            # COPY HEADERS DIRECTLY to /usr/local/include (Flattened structure for CMake)
            # This ensures find_path(ONNXRUNTIME_INCLUDE_DIR ...) finds them immediately
            cp -r /tmp/onnxruntime-${ORT_VER:1}/include/onnxruntime/core/session/* /usr/local/include/
            cp -r /tmp/onnxruntime-${ORT_VER:1}/include/onnxruntime/core/providers/* /usr/local/include/ 2>/dev/null || true
            
            # Cleanup
            rm -rf /tmp/ort.tar.gz /tmp/onnxruntime-${ORT_VER:1}
          fi

- name: Ensure Jetson clocks service
  ansible.builtin.template: 
    src: templates/jetson_clocks.j2
    dest: /etc/systemd/system/jetson_clocks.service

- name: Start and enable clocks service
  ansible.builtin.systemd:
    name: jetson_clocks
    state: started
    enabled: true
    daemon_reload: true


- name: Update WiFi power save configuration
  become: yes
  block:
    - name: Create NetworkManager WiFi power save disable configuration
      ansible.builtin.template: 
        src: templates/90-disable-wifi-powersave.conf.j2
        dest: /etc/NetworkManager/conf.d/90-disable-wifi-powersave.conf
        mode: '0644'
      register: disable_powersave1
    
    - name: Remove default NetworkManager WiFi power save configuration
      ansible.builtin.file:
        path: /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf
        state: absent
      register: disable_powersave2

    - name: Restart nmcli if needed
      when: disable_powersave1.changed or disable_powersave2.changed
      ansible.builtin.systemd: 
        name: NetworkManager
        state: restarted
- name: "Setup VNC"
  block: 
    - name: Enable Automatic Login
      ansible.builtin.lineinfile: 
        path: /etc/gdm3/custom.conf
        regexp: 'AutomaticLoginEnable'
        line: 'AutomaticLoginEnable=true'
    - name: Set automatic login user
      ansible.builtin.lineinfile: 
        path: /etc/gdm3/custom.conf
        regexp: 'AutomaticLogin'
        line: 'AutomaticLogin=lis'
    - name: Install xorg dummy
      ansible.builtin.apt: 
        name: 
          - xserver-xorg-video-dummy
          - vino
    - name: Add vino to graphical session wants
      ansible.builtin.file: 
        src: /usr/lib/systemd/user/vino-server.service
        path: /usr/lib/systemd/user/graphical-session.target.wants/vino-server.service
        state: "link"
    - name: "Set gsettings"
      become: false
      block:
        # TODO: for some reason the community dcom modifier doesn't work. this is a hack to keep going. 
        - name: "Disable prompt requirement"
          ansible.builtin.command: gsettings set org.gnome.Vino prompt-enabled false 
        - name: "Disable encryption"
          ansible.builtin.command: gsettings set org.gnome.Vino require-encryption false
        - name: "Set VNC as auth method"
          ansible.builtin.command: gsettings set org.gnome.Vino authentication-methods "['vnc']"

          # shell to allow for this evaluation 
        - name: "Set password"
          ansible.builtin.shell: gsettings set org.gnome.Vino vnc-password $(echo -n 'orin'|base64)  # TODO: actual password? 

    - name: "xorg configuration"
      ansible.builtin.blockinfile:
        path: /etc/X11/xorg.conf
        append_newline: true
        prepend_newline: true
        block: |
          Section "Device"
          Identifier "Dummy0"
          Driver "dummy"
          VideoRam 16384
          EndSection

          Section "Monitor"
          Identifier "Monitor0"
          HorizSync 5.0-1000.0
          VertRefresh 5.0-200.0
          Modeline "1280x800" 24.15 1280 1312 1400 1432 800 819 822 841
          # Modeline "1920x1080_24.00" 173.00 1920 2048 2248 2576 1080 1083 1088 1120
          EndSection

          Section "Screen"
          Identifier "Screen0"
          Monitor "Monitor0"
          Device "Dummy0"
          DefaultDepth 24
          SubSection "Display"
          Depth 24
          Virtual 1280 800
          # Virtual 1920 1080
          EndSubSection
          EndSection
- name: Setup ROS
  block: 
    - name: Ensure universe is present
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        line: "deb http://ports.ubuntu.com/ubuntu-ports/ {{ ansible_distribution_release }} main restricted universe"
        regexp: "{{ ansible_distribution_release }} (main|restricted|universe) (main|restricted|universe) (main|restricted|universe)"
    - name: Ensure universe updates is present
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        line: "deb http://ports.ubuntu.com/ubuntu-ports/ {{ ansible_distribution_release }}-updates main restricted universe"
        regexp: "{{ ansible_distribution_release }}-updates (main|restricted|universe) (main|restricted|universe) (main|restricted|universe)" 
    - name: Add ROS 2 apt
      block:
        - name: Add apt key 
          ansible.builtin.get_url:
            url: https://raw.githubusercontent.com/ros/rosdistro/master/ros.key
            dest: /usr/share/keyrings/ros-archive-keyring.gpg

        - name: Add ROS Repository
          ansible.builtin.apt_repository:
            repo: "deb [arch=arm64 signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu {{ ansible_distribution_release }} main"
            state: present
        - name: Download ROS
          ansible.builtin.include_tasks: "download-ros.yml"
        - name: Set bashrc with ROS and aliases
          become: false
          ansible.builtin.blockinfile: 
            path: /home/lis/.bashrc
            block: |
              source /opt/ros/humble/setup.bash
              export ROS_DOMAIN_ID={{ drone_num }} 
              
              # ROS package systemctl aliases
              alias ros_status='systemctl --user status ros_packages'
              alias ros_start='systemctl --user start ros_packages'
              alias ros_stop='systemctl --user stop ros_packages'
              alias ros_restart='systemctl --user restart ros_packages'
              
              # ROS package logs function with argument support
              ros_logs() {
                journalctl --user -u ros_packages "$@"
              } 

        - name: Get Geographic Lib
          ansible.builtin.include_tasks: "geographic-lib.yml"       
        - name: Ensure persistent storage in journald.conf
          become: true
          ansible.builtin.replace:
            path: /etc/systemd/journald.conf
            regexp: '^\s*#?Storage=.*$'
            replace: 'Storage=persistent'
                        
   
- name: Check for zellij 
  ansible.builtin.command: zellij --version 
  register: zellij_check
  changed_when: false
  failed_when: false

- name: Install zellij if needed
  when: zellij_check.rc != 0
  block:
    - name: Get zellij release
      ansible.builtin.get_url:
        url: https://github.com/zellij-org/zellij/releases/latest/download/zellij-aarch64-unknown-linux-musl.tar.gz
        dest: /tmp/zellij.tar.gz
    - name: Extract zellij
      become: true
      ansible.builtin.unarchive: 
        src: /tmp/zellij.tar.gz
        dest: /usr/bin/
        remote_src: true


- name: Camera prereqs
  block:
    - name: Ensure Movidius udev rule exists
      ansible.builtin.copy:
        content: 'SUBSYSTEM=="usb", ATTRS{idVendor}=="03e7", MODE="0666"'
        dest: /etc/udev/rules.d/80-movidius.rules
        mode: '0644'
      register: udev_rule_result

    - name: Reload udev rules if changed
      ansible.builtin.shell: udevadm control --reload-rules && udevadm trigger
      when: udev_rule_result.changed

    - name: Check if depthai zip exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/build_artifacts/depthai-v2.29.0-build.zip"
        checksum_algorithm: sha256
        get_checksum: yes
      register: depthai_zip
      delegate_to: localhost
      become: false

    - name: Extract zip
      when: depthai_zip.stat.exists and depthai_zip.stat.checksum == '67e655426e5f7a26197c71c922df6c4351634397991c7c042bab129af9e3bf8b' 
      ansible.builtin.unarchive: 
        src: "{{ playbook_dir }}/build_artifacts/depthai-v2.29.0-build.zip"
        dest: /tmp 

    - name: Manually download and build depthai
      when: not depthai_zip.stat.exists or depthai_zip.stat.checksum != '67e655426e5f7a26197c71c922df6c4351634397991c7c042bab129af9e3bf8b' 
      block:
      - name: Download depthai-core
        ansible.builtin.get_url:
          url: https://github.com/luxonis/depthai-core/releases/download/v2.29.0/depthai-core-v2.29.0.tar.gz
          dest: /tmp/depthai-core-v2.29.0.tar.gz
      
      - name: Extract depthai-core
        ansible.builtin.unarchive:
          src: /tmp/depthai-core-v2.29.0.tar.gz
          dest: /tmp
          remote_src: true
      
      - name: Build depthai-core
        ansible.builtin.shell:
          cmd: cmake -B build && cmake --build build --parallel $(nproc) && cmake --install build
          chdir: /tmp/depthai-core-v2.29.0
      
    - name: Copy depthai headers to system location
      ansible.builtin.copy:
        src: /tmp/depthai-core-v2.29.0/build/install/include/
        dest: /usr/local/include/
        remote_src: true
        mode: preserve

    - name: Copy depthai libraries to system location
      ansible.builtin.copy:
        src: /tmp/depthai-core-v2.29.0/build/install/lib/
        dest: /usr/local/lib/
        remote_src: true
        mode: preserve

- name: MicroXRCE 
  ansible.builtin.include_tasks: install-microxrce.yml

- name: Gurobi 
  ansible.builtin.include_tasks: install-gurobi.yml
  
- name: Acados 
  ansible.builtin.include_tasks: install-acados.yml

- name: NXT compatability
  block: 
    - name: Allow rootless access to flight controller
      ansible.builtin.user:
        name: "lis"
        groups: dialout
        append: true
    - name: Remove modemmanager # maybe not necessary to be tested TODO
      ansible.builtin.apt:
        name: modemmanager
        state: absent
    - name: Install mavtools
      ansible.builtin.pip:
        name: 
          - mavsdk
          - mavproxy

- name: Chrony Configuration 
  block:
    - name: Install Chrony
      ansible.builtin.apt: 
        name: chrony

- name: Set WiFi
  community.general.nmcli: 
    type: wifi
    conn_name: default_drones
    ifname: "{{ drone_wifi_interface }}"
    ssid: "{{ wifi_ssid }}"
    wifi_sec: 
      key-mgmt: wpa-psk
      psk: "{{ wifi_password }}"
    autoconnect: true
    state: present

- name: Set max power mode 
  ansible.builtin.command: nvpmodel -m 0 
  async: 1
  poll: 0 # skip to next task 
  ignore_errors: true # TODO: make this less fragile

- name: Reboot system and wait for it to come back
  ansible.builtin.reboot:
    reboot_timeout: 600        
    test_command: whoami
