- name: Check Internet connectivity (Ping)
  block:
    - name: Ping Google DNS
      ansible.builtin.command: ping -c 1 -W 2 8.8.8.8
      register: ping_check
      changed_when: false
      # 0 means success (reachable), anything else is failure
      failed_when: ping_check.rc != 0
      retries: 1
      delay: 3

  rescue:
    - name: Fail if Internet is not reachable
      ansible.builtin.fail:
        msg: "No Internet connectivity (Ping 8.8.8.8 failed). Please check network settings."

- name: Force sync date from Google HTTP Header
  become: true
  ansible.builtin.shell: |
    # 1. Get headers from google
    # 2. Find the Date line
    # 3. Remove everything up to 'Date: ' (handling variable whitespace)
    # 4. Take the first result only (in case of redirects)
    NEW_DATE=$(wget -4 --no-check-certificate -qSO- --max-redirect=0 google.com 2>&1 | grep "Date:" | sed 's/.*Date: //g' | head -n 1)

    # Set the date
    date -s "$NEW_DATE"
  args:
    executable: /bin/bash

- name: Check kernel, patch if needed
  ansible.builtin.include_tasks: "patch-kernel.yml"
- name: Add Docker apt repository
  block:
    - name: Remove existing Docker repository definition to prevent conflicts
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/docker.list
        state: absent

    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
        state: present
        update_cache: yes

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Add Docker repository
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/docker.list
        line: "deb [arch=arm64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        create: yes

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

- name: Ensure apt packages are installed
  ansible.builtin.apt:
    name:
      - python3-pip
      - python3-loguru
      - python3-yaml
      - htop
      - sysstat
      - chrony
      - docker-ce=5:27.5*
      - docker-ce-cli=5:27.5*
      - libusb-1.0-0-dev
      - libboost-python-dev

    state: present
    allow_downgrade: true

- name: Install nvidia toolkit (System Package)
  ansible.builtin.apt:
    name: nvidia-jetpack
    state: present
    update_cache: yes

- name: Jetson Stats
  ansible.builtin.pip:
    name:
      - jetson-stats

- name: Install ONNX Runtime (C++ Dev Files)
  become: true
  block:
    - name: Install onnxruntime-gpu pip package (JetPack 6)
      pip:
        name: onnxruntime-gpu
        extra_args: "--index-url https://pypi.jetson-ai-lab.io/jp6/cu126 --upgrade"
        executable: pip3

    - name: Find onnxruntime location
      shell: pip3 show onnxruntime-gpu | grep Location | cut -d " " -f 2
      register: ort_pip_loc
      changed_when: false

    - name: Symlink ONNX Runtime libraries
      shell: |
        ln -sf {{ ort_pip_loc.stdout }}/onnxruntime/capi/libonnxruntime.so.* /usr/local/lib/
        ln -sf {{ ort_pip_loc.stdout }}/onnxruntime/capi/libonnxruntime_providers_*.so /usr/local/lib/

        ORT_SO=$(find {{ ort_pip_loc.stdout }}/onnxruntime/capi -name "libonnxruntime.so.*" | head -n 1)
        ln -sf $ORT_SO /usr/local/lib/libonnxruntime.so

        ldconfig

    - name: Download and Install ONNX Runtime Headers
      shell: |
        set -e
        ORT_TAG="v1.17.0"
        ORT_VERSION="1.17.0"

        if [ ! -f /usr/local/include/onnxruntime_cxx_api.h ]; then
          wget "https://github.com/microsoft/onnxruntime/archive/refs/tags/$ORT_TAG.tar.gz" -O /tmp/ort.tar.gz
          tar -xf /tmp/ort.tar.gz -C /tmp/

          cp -r "/tmp/onnxruntime-$ORT_VERSION/include/onnxruntime/core/session/"* /usr/local/include/
          cp -r "/tmp/onnxruntime-$ORT_VERSION/include/onnxruntime/core/providers/"* /usr/local/include/ 2>/dev/null || true

          rm -rf /tmp/ort.tar.gz "/tmp/onnxruntime-$ORT_VERSION"
        fi
      args:
        executable: /bin/bash

- name: Ensure Jetson clocks service
  ansible.builtin.template:
    src: templates/jetson_clocks.j2
    dest: /etc/systemd/system/jetson_clocks.service

- name: Start and enable clocks service
  ansible.builtin.systemd:
    name: jetson_clocks
    state: started
    enabled: true
    daemon_reload: true


- name: Update WiFi power save configuration
  become: yes
  block:
    - name: Create NetworkManager WiFi power save disable configuration
      ansible.builtin.template:
        src: templates/90-disable-wifi-powersave.conf.j2
        dest: /etc/NetworkManager/conf.d/90-disable-wifi-powersave.conf
        mode: '0644'
      register: disable_powersave1

    - name: Remove default NetworkManager WiFi power save configuration
      ansible.builtin.file:
        path: /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf
        state: absent
      register: disable_powersave2

    - name: Restart nmcli if needed
      when: disable_powersave1.changed or disable_powersave2.changed
      ansible.builtin.systemd:
        name: NetworkManager
        state: restarted
- name: "Setup VNC"
  block:
    - name: Enable Automatic Login
      ansible.builtin.lineinfile:
        path: /etc/gdm3/custom.conf
        regexp: 'AutomaticLoginEnable'
        line: 'AutomaticLoginEnable=true'
    - name: Set automatic login user
      ansible.builtin.lineinfile:
        path: /etc/gdm3/custom.conf
        regexp: 'AutomaticLogin'
        line: 'AutomaticLogin=lis'
    - name: Install xorg dummy
      ansible.builtin.apt:
        name:
          - xserver-xorg-video-dummy
          - vino
    - name: Add vino to graphical session wants
      ansible.builtin.file:
        src: /usr/lib/systemd/user/vino-server.service
        path: /usr/lib/systemd/user/graphical-session.target.wants/vino-server.service
        state: "link"
    - name: "Set gsettings"
      become: false
      block:
        # TODO: for some reason the community dcom modifier doesn't work. this is a hack to keep going.
        - name: "Disable prompt requirement"
          ansible.builtin.command: gsettings set org.gnome.Vino prompt-enabled false
        - name: "Disable encryption"
          ansible.builtin.command: gsettings set org.gnome.Vino require-encryption false
        - name: "Set VNC as auth method"
          ansible.builtin.command: gsettings set org.gnome.Vino authentication-methods "['vnc']"

          # shell to allow for this evaluation
        - name: "Set password"
          ansible.builtin.shell: gsettings set org.gnome.Vino vnc-password $(echo -n 'orin'|base64)  # TODO: actual password?

    - name: "xorg configuration"
      ansible.builtin.blockinfile:
        path: /etc/X11/xorg.conf
        append_newline: true
        prepend_newline: true
        block: |
          Section "Device"
          Identifier "Dummy0"
          Driver "dummy"
          VideoRam 16384
          EndSection

          Section "Monitor"
          Identifier "Monitor0"
          HorizSync 5.0-1000.0
          VertRefresh 5.0-200.0
          Modeline "1280x800" 24.15 1280 1312 1400 1432 800 819 822 841
          # Modeline "1920x1080_24.00" 173.00 1920 2048 2248 2576 1080 1083 1088 1120
          EndSection

          Section "Screen"
          Identifier "Screen0"
          Monitor "Monitor0"
          Device "Dummy0"
          DefaultDepth 24
          SubSection "Display"
          Depth 24
          Virtual 1280 800
          # Virtual 1920 1080
          EndSubSection
          EndSection
- name: Setup ROS
  block:
    - name: Ensure universe is present
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        line: "deb http://ports.ubuntu.com/ubuntu-ports/ {{ ansible_distribution_release }} main restricted universe"
        regexp: "{{ ansible_distribution_release }} (main|restricted|universe) (main|restricted|universe) (main|restricted|universe)"
    - name: Ensure universe updates is present
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        line: "deb http://ports.ubuntu.com/ubuntu-ports/ {{ ansible_distribution_release }}-updates main restricted universe"
        regexp: "{{ ansible_distribution_release }}-updates (main|restricted|universe) (main|restricted|universe) (main|restricted|universe)"
    - name: Add ROS 2 apt
      block:
        - name: Add apt key
          ansible.builtin.get_url:
            url: https://raw.githubusercontent.com/ros/rosdistro/master/ros.key
            dest: /usr/share/keyrings/ros-archive-keyring.gpg

        - name: Add ROS Repository
          ansible.builtin.apt_repository:
            repo: "deb [arch=arm64 signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu {{ ansible_distribution_release }} main"
            state: present
        - name: Download ROS
          ansible.builtin.include_tasks: "download-ros.yml"
        - name: Set bashrc with ROS and aliases
          become: false
          ansible.builtin.blockinfile:
            path: /home/lis/.bashrc
            block: |
              source /opt/ros/humble/setup.bash
              export ROS_DOMAIN_ID={{ drone_num }}

              # ROS package systemctl aliases
              alias ros_status='systemctl --user status ros_packages'
              alias ros_start='systemctl --user start ros_packages'
              alias ros_stop='systemctl --user stop ros_packages'
              alias ros_restart='systemctl --user restart ros_packages'

              # ROS package logs function with argument support
              ros_logs() {
                journalctl --user -u ros_packages "$@"
              }

        - name: Get Geographic Lib
          ansible.builtin.include_tasks: "geographic-lib.yml"
        - name: Ensure persistent storage in journald.conf
          become: true
          ansible.builtin.replace:
            path: /etc/systemd/journald.conf
            regexp: '^\s*#?Storage=.*$'
            replace: 'Storage=persistent'


- name: Check for zellij
  ansible.builtin.command: zellij --version
  register: zellij_check
  changed_when: false
  failed_when: false

- name: Install zellij if needed
  when: zellij_check.rc != 0
  block:
    - name: Get zellij release
      ansible.builtin.get_url:
        url: https://github.com/zellij-org/zellij/releases/latest/download/zellij-aarch64-unknown-linux-musl.tar.gz
        dest: /tmp/zellij.tar.gz
    - name: Extract zellij
      become: true
      ansible.builtin.unarchive:
        src: /tmp/zellij.tar.gz
        dest: /usr/bin/
        remote_src: true


- name: Camera prereqs (DepthAI v3.2.1)
  block:
    - name: Ensure Movidius udev rule exists
      ansible.builtin.copy:
        content: 'SUBSYSTEM=="usb", ATTRS{idVendor}=="03e7", MODE="0666"'
        dest: /etc/udev/rules.d/80-movidius.rules
        mode: '0644'
      register: udev_rule_result

    - name: Reload udev rules if changed
      ansible.builtin.shell: udevadm control --reload-rules && udevadm trigger
      when: udev_rule_result.changed

    - name: Check if DepthAI library headers exist (Simple check)
      ansible.builtin.stat:
        path: /usr/local/include/depthai/depthai.hpp
      register: depthai_installed

    - name: Download and install depthai-core v3.2.1 (Source)
      when: not depthai_installed.stat.exists
      block:
        - name: Download depthai-core
          ansible.builtin.get_url:
            url: https://github.com/luxonis/depthai-core/releases/download/v3.2.1/depthai-core-v3.2.1.tar.gz
            dest: /tmp/depthai-core-v3.2.1.tar.gz

        - name: Extract depthai-core
          ansible.builtin.unarchive:
            src: /tmp/depthai-core-v3.2.1.tar.gz
            dest: /tmp
            remote_src: true

        - name: Build depthai-core (Shared Libs)
          ansible.builtin.shell: |
            cmake -S . -B build -DBUILD_SHARED_LIBS=ON
            cmake --build build --parallel $(nproc)
          args:
            chdir: /tmp/depthai-core-v3.2.1

        - name: Install depthai-core
          become: true
          ansible.builtin.shell: cmake --install build
          args:
            chdir: /tmp/depthai-core-v3.2.1

    - name: Run ldconfig
      ansible.builtin.command: ldconfig

- name: Build cv_bridge from source (for OpenCV 4.8.0)
  become: false
  block:
    - name: Ensure workspace directory exists
      become: true
      ansible.builtin.file:
        path: "{{ drone_ros_path }}/src"
        state: directory
        owner: lis
        group: lis

    - name: Clone vision_opencv (Humble)
      ansible.builtin.git:
        repo: 'https://github.com/ros-perception/vision_opencv.git'
        dest: "{{ drone_ros_path }}/src/vision_opencv"
        version: humble
        force: no

    - name: Build cv_bridge with custom OpenCV
      ansible.builtin.shell: |
        source /opt/ros/humble/setup.bash
        colcon build --symlink-install --packages-select cv_bridge --allow-overriding cv_bridge --cmake-args -DOpenCV_DIR=/usr/local/lib/cmake/opencv4
      args:
        chdir: "{{ drone_ros_path }}"
        executable: /bin/bash

- name: MicroXRCE
  ansible.builtin.include_tasks: install-microxrce.yml

- name: Gurobi
  ansible.builtin.include_tasks: install-gurobi.yml

- name: Acados
  ansible.builtin.include_tasks: install-acados.yml

- name: NXT compatability
  block:
    - name: Allow rootless access to flight controller
      ansible.builtin.user:
        name: "lis"
        groups: dialout
        append: true
    - name: Remove modemmanager # maybe not necessary to be tested TODO
      ansible.builtin.apt:
        name: modemmanager
        state: absent
    - name: Install mavtools
      ansible.builtin.pip:
        name:
          - mavsdk
          - mavproxy

- name: Chrony Configuration
  block:
    - name: Install Chrony
      ansible.builtin.apt:
        name: chrony

- name: Set WiFi
  community.general.nmcli:
    type: wifi
    conn_name: default_drones
    ifname: "{{ drone_wifi_interface }}"
    ssid: "{{ wifi_ssid }}"
    wifi_sec:
      key-mgmt: wpa-psk
      psk: "{{ wifi_password }}"
    autoconnect: true
    state: present

- name: Set max power mode
  ansible.builtin.command: nvpmodel -m 0
  async: 1
  poll: 0 # skip to next task
  ignore_errors: true # TODO: make this less fragile

- name: Configure real-time priority limits for the current user
  ansible.builtin.copy:
    dest: /etc/security/limits.d/99-realtime.conf
    content: |
      lis    -    rtprio   99
      lis    -    memlock  unlimited
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Reboot system and wait for it to come back
  ansible.builtin.reboot:
    reboot_timeout: 600
    test_command: whoami
