
---

- name: Copy the local log to the right place  
  hosts: localhost
  gather_facts: true
  vars:
    timestamp: "{{ lookup('pipe', 'date +%Y/%m/%d/%H%M%S') }}"
  tasks:
    - name: Create facts
      set_fact:
        run_dir: "{{ host_base_path }}/consolidated_logs/{{ timestamp }}"
    - name: Create timestamped run directory on controller
      ansible.builtin.file:
       path: "{{ run_dir }}"
       state: directory
       mode: "0755"

    - name: Copy latest logs to consolidated folder
      ansible.posix.synchronize: 
       mode: push
       src: "{{ host_base_path }}/logs/latest"
       dest: "{{ run_dir }}/host"
       recursive: yes
       archive: yes
       compress: yes
       rsync_opts: 
         - "--mkpath"
    - name: Create latest consolidated log link
      ansible.builtin.file:
        src: "{{ run_dir }}"
        dest: "{{ host_base_path }}/consolidated_logs/latest"
        state: link

- name: Collect logs from drones into timestamped run folder
  hosts: drones
  remote_user: lis
  gather_facts: true
  tasks:
    - name: Copy MAVLink log collection script to drone
      ansible.builtin.template:
        src: scripts/get_mavlogs.py
        dest: /tmp/get_mavlogs.py
        mode: '0755'
    
    - name: Download MAVLink logs from flight controller
      ansible.builtin.shell: python3 /tmp/get_mavlogs.py
      register: mavlink_log_result
      failed_when: false  # Don't fail the whole playbook if MAVLink logs unavailable
      changed_when: false
    
    - name: Log MAVLink collection result
      ansible.builtin.debug:
        msg: "MAVLink log collection: {{ mavlink_log_result.stdout_lines | default(['No output']) }}"
      when: mavlink_log_result is defined
    
    - name: Pull latest log contents from each drone into its hostname subfolder
      ansible.posix.synchronize:
        mode: pull
        src: "{{ drone_base_path }}/logs/latest/"   # trailing slash = copy CONTENTS
        dest: "{{ host_base_path }}/consolidated_logs/latest/{{ ansible_hostname }}/"
        recursive: yes
        archive: yes
        compress: yes
        rsync_opts:
          - "--mkpath"
      delegate_to: localhost

