---

- name: Copy the local log to the right place
  hosts: localhost
  gather_facts: true
  vars:
    timestamp: "{{ lookup('pipe', 'date +%Y/%m/%d/%H%M%S') }}"
  tasks:
    - name: Create facts
      set_fact:
        run_dir: "{{ host_base_path }}/consolidated_logs/{{ timestamp }}"
    - name: Create timestamped run directory on controller
      ansible.builtin.file:
       path: "{{ run_dir }}"
       state: directory
       mode: "0755"

    - name: Copy latest logs to consolidated folder
      ansible.posix.synchronize:
       mode: push
       src: "{{ host_base_path }}/logs/latest"
       dest: "{{ run_dir }}/host"
       recursive: yes
       archive: yes
       compress: yes
       rsync_opts:
         - "--mkpath"
    - name: Create latest consolidated log link
      ansible.builtin.file:
        src: "{{ run_dir }}"
        dest: "{{ host_base_path }}/consolidated_logs/latest"
        state: link

- name: Collect logs from drones into timestamped run folder
  hosts: drones
  remote_user: lis
  gather_facts: true
  tasks:
    # 1. Stop the nodes to ensure files are closed and stats written
    - name: Stop ROS packages to flush logs
      ansible.builtin.systemd:
        name: ros_packages
        state: stopped
        scope: user

    # 2. Wait a moment to ensure IO operations complete
    - name: Wait for shutdown flush
      ansible.builtin.pause:
        seconds: 3

    # 3. Collect the data
    - name: Pull latest log contents from each drone into its hostname subfolder
      ansible.posix.synchronize:
        mode: pull
        src: "{{ drone_base_path }}/logs/latest/"
        dest: "{{ host_base_path }}/consolidated_logs/latest/{{ ansible_hostname }}/"
        recursive: yes
        archive: yes
        compress: yes
        rsync_opts:
          - "--mkpath"
      delegate_to: localhost

    - name: Pull MPC and Planner logs
      ansible.posix.synchronize:
        mode: pull
        src: "{{ item.src }}"
        dest: "{{ host_base_path }}/consolidated_logs/latest/{{ ansible_hostname }}/{{ item.name }}/"
        recursive: yes
        archive: yes
        compress: yes
        rsync_opts:
          - "--mkpath"
      delegate_to: localhost
      ignore_errors: true
      loop:
        - { src: "/tmp/mpc_logs/latest/", name: "mpc_logs" }
        - { src: "/tmp/planner_logs/", name: "planner_logs" }

    - name: Pull Depth logs
      when: enable_vision | default(false) | bool
      ansible.posix.synchronize:
        mode: pull
        src: "/tmp/depth_logs/"
        dest: "{{ host_base_path }}/consolidated_logs/latest/{{ ansible_hostname }}/depth_logs/"
        recursive: yes
        archive: yes
        compress: yes
        rsync_opts:
          - "--mkpath"
      delegate_to: localhost
      ignore_errors: true

    # 4. Restart the nodes immediately (while analysis runs on host)
    - name: Restart ROS packages
      ansible.builtin.systemd:
        name: ros_packages
        state: started
        scope: user

    # 5. Run Analysis
    - name: Analyze consolidated logs
      ansible.builtin.command: >
        python3 scripts/analyze_logs.py --log-dir "{{ host_base_path }}/consolidated_logs/latest"
      args:
        chdir: "{{ playbook_dir }}"
      register: analysis_output
      delegate_to: localhost
      run_once: true

    - name: Display analysis results
      ansible.builtin.debug:
        msg: "{{ analysis_output.stdout_lines }}"
      delegate_to: localhost
      run_once: true
