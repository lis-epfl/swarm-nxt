---
- name: Preflight
  hosts: drones
  remote_user: lis
  become: yes # runs everything with sudo 
  vars: 
    gcs_url: "adminlis-ThinkPad-T450s.local" # get this machine's url. 

  tasks:
    - name: Remove all sources
      ansible.builtin.replace: 
        path: /etc/chrony/chrony.conf
        regexp: "^((pool)|(sourcedir))" 
        replace: "# \\1"
        
    - name: Add host IPs
      ansible.builtin.blockinfile:
       path: /etc/chrony/chrony.conf
       block: | # change the possible ips and chrony min/max poll in ansible/group_vars/all
           server {{ gcs_url }}  iburst minpoll {{ chrony_minpoll }} maxpoll {{ chrony_maxpoll }}
    - name: Restart chronyd
      ansible.builtin.systemd:
        name: chronyd
        state: restarted

    - name: Create mavros launch script 
      become: false
      ansible.builtin.template: 
        src: scripts/mavros_start.sh
        dest: /home/lis/mavros_start.sh
        mode: "755"

    - name: Install mavros service 
      ansible.builtin.template: 
        src: templates/mavros_service.j2
        dest: /etc/systemd/system/mavros.service

      
    - name: Start and enable mavros service
      ansible.builtin.systemd: 
        name: mavros
        state: restarted
        enabled: false
        daemon_reload: true
    
    - name: Ensure ros2_ws exists
      ansible.builtin.file:
        path: /home/lis/ros2_ws/src
        state: directory



    - name: Set correct pose topic for mocap_to_vision_pose # TODO: Perhaps patch mocap_to_vision_pose_ros2
      ansible.builtin.replace: 
        path: /home/lis/ros2_ws/src/mocap_to_vision_pose_ros2/config/config.yaml
        regexp: "/optitrack_multiplexer_node/rigid_body/[A-Za-z_0-9]+"
        replace: "/optitrack_multiplexer_node/rigid_body/{{ ansible_facts['nodename'] }}" # this will be dynamic so can drop
    
    - name: Build mocap_to_vision_pose
      become: false
      ansible.builtin.shell: . /opt/ros/humble/setup.sh && colcon build --symlink-install 
      args:
        chdir: /home/lis/ros2_ws

    - name: Create mocap_to_vision script
      become: false
      ansible.builtin.template: 
        src: scripts/mocap_start.sh
        dest: /home/lis/mocap_start.sh
        mode: "755"
    
    - name: Install mocap service 
      ansible.builtin.template: 
        src: templates/mocap_service.j2
        dest: /etc/systemd/system/mocap.service

      
    - name: Start mocap service
      ansible.builtin.systemd: 
        name: mocap
        state: restarted
        enabled: false
        daemon_reload: true
      

    
    - name: "Mocap Checks"
      when: "position_estimation == 'optitrack'"
      block:
      - name: Wait for one minute before checking... # this can be better if we can check ros
        ansible.builtin.pause:
          seconds: 60
      
      - name: "Collect systemd stats"
        ansible.builtin.service_facts:
      - name: Mocap running check
        when: "position_estimation == 'optitrack'"
        ansible.builtin.assert: 
          that: "services['mocap.service']['state'] == 'running' and services['mocap.service']['status'] != 'failed'"
          fail_msg: "Mocap is not running properly!"
      
    
    - name: Mavros running check
      ansible.builtin.assert: 
        that: "services['mavros.service']['state'] == 'running' and services['mavros.service']['status'] != 'failed'"
        fail_msg: "Mavros is not running properly!" 
    
    - name: Chrony Tracking Check
      block: 
        - name: Copy script
          ansible.builtin.copy: 
            src: scripts/chronyc_check.py
            dest: /tmp/chronyc_check.py
            mode: '0755'
          
        - name: Check if we're tracking
          ansible.builtin.shell: /tmp/chronyc_check.py
          register: chronyc_check
          changed_when: false
    

- name: Local Actions
  connection: local
  hosts: localhost
  tasks:
    - name: Local Mocap
      when: "position_estimation == 'optitrack'"
      delegate_to: 127.0.0.1
      connection: local
      block:
      - name: Modify wrapper config file
        ansible.builtin.lineinfile: 
          path: "{{ host_ros_path }}/src/optitrack_wrapper_ros2/config/optitrack_wrapper_config.yaml"
          regexp: "^(\\s+)server_address:\\s?.*"
          backrefs: true
          line: "\\1server_address: \"{{ optitrack_server_ip }}\""
      - name: Modify multiplexer config file
        ansible.builtin.lineinfile: 
          path: "{{ host_ros_path }}/src/optitrack_multiplexer_ros2/config/optitrack_multiplexer_config.yaml"
          regexp: "^(\\s+)rigid_body_names:\\s?.*"
          backrefs: true
          line: "\\1rigid_body_names: \"{{ groups['drones'] |  map('regex_replace', '\\.local$', '') | join(',') }}\""
      
        # modify the local config variables for the stuff to export




      

