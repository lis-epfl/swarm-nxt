---

- name: Local Actions
  connection: local
  hosts: localhost
  tasks:
    - name: Local ROS Packages
      when: "position_estimation == 'optitrack'"
      delegate_to: 127.0.0.1
      connection: local
      block:
      - name: Build local packages
        ansible.builtin.shell: ". /opt/ros/humble/setup.sh && colcon build"
        args:
          chdir: "{{ host_ros_path }}"

      - name: Create local launch file
        ansible.builtin.template: 
          src: templates/host_launch.py.j2
          dest: "{{ host_base_path }}/launch.py"
      - name: Create ros_packages script 
        become: false
        vars: 
          ros_path: "{{ host_ros_path }}"
          base_path: "{{ host_base_path }}"
        ansible.builtin.template: 
          src: scripts/ros_packages_start.sh
          dest: "{{ host_base_path }}/ros_packages_start.sh"
          mode: "755"
     
      - name: Create config directory
        ansible.builtin.file:
          dest: "{{ host_ros_path }}/config"
          state: directory
          mode: "755"
    
      - name: Copy peer list
        ansible.builtin.template: 
          src: templates/peer_list.yaml.j2
          dest: "{{ host_ros_path }}/config/peer_list.yaml"
          mode: "644"
        vars:
          peers: "{{ groups['drones'] | map('regex_replace', '\\.local$', '') | join('\n') }}"
      
      - name: Send bridge configuration 
        ansible.builtin.template: 
          src: templates/host_bridge_config.yaml.j2
          dest: "{{ host_ros_path }}/config/bridge_config.yaml"
          mode: "644"

      - name: Create local systemd folder
        ansible.builtin.file:
          dest: "~/.local/share/systemd/user"
          state: directory
          
      - name: Copy ros_packages service 
        vars:
          base_path: "{{ host_base_path }}"
        ansible.builtin.template: 
          src: templates/ros_packages_service.j2
          dest: ~/.local/share/systemd/user/ros_packages.service
      - name: Start ros_packages service
        ansible.builtin.systemd:
          name: "ros_packages"
          state: restarted
          enabled: false
          scope: user
          daemon_reload: true

- name: Preflight
  hosts: drones
  remote_user: lis
  vars: 
    gcs_url: "{{ host_hostname }}.local" 

  tasks:

    - name: Chrony Stuff
      become: yes
      block:
      - name: Remove all sources
        become: yes
        ansible.builtin.replace: 
          path: /etc/chrony/chrony.conf
          regexp: "^((pool)|(sourcedir))" 
          replace: "# \\1"
        
      - name: Add host IPs
        ansible.builtin.blockinfile:
          path: /etc/chrony/chrony.conf
          block: | # change the possible ips and chrony min/max poll in ansible/group_vars/all
              server {{ gcs_url }}  iburst minpoll {{ chrony_minpoll }} maxpoll {{ chrony_maxpoll }}
      - name: Restart chronyd
        ansible.builtin.systemd:
          name: chronyd
          state: restarted

    - name: Create directories
      ansible.builtin.file:
        dest: "{{ item.dest }}"
        state: directory
        mode: "755"
      loop: 
        - {dest: "{{ drone_ros_path }}/config"}
        - {dest: "{{ drone_base_path }}/scripts"}
        - {dest: "{{ drone_base_path }}/logs/scripts"}
        - {dest: "~/.local/share/systemd/user"}
    
    - name: Send files
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: "644"
      loop:
        - { src: "templates/peer_list.yaml.j2", dest: "{{ drone_ros_path }}/config/peer_list.yaml" }
        - { src: "templates/drone_bridge_config.yaml.j2", dest: "{{ drone_ros_path }}/config/bridge_config.yaml" }
        - { src: "templates/mcap_bag_options.yml", dest: "{{ drone_ros_path }}/config/mcap_bag_options.yml"}
        - { src: "templates/bounds.json", dest: "{{ drone_ros_path }}/config/bounds.json"}
        - { src: "templates/drone_launch.py.j2", dest: "{{ drone_base_path }}/launch.py"}
        - { src: "templates/ros_packages_service.j2", dest: "~/.local/share/systemd/user/ros_packages.service"}
      vars:
        peers: "{{ groups['drones'] | map('regex_replace', '\\.local$', '') | join('\n') }}"
        ros_path: "{{ drone_ros_path }}"
        base_path: "{{ drone_base_path }}"
        
      
    - name: Send executable files
      ansible.builtin.template: 
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: "0755"
      vars: 
        ros_path: "{{ drone_ros_path }}"
        base_path: "{{ drone_base_path }}"
      loop: 
        - { src: "scripts/ros_packages_start.sh", dest: "{{ drone_base_path }}/ros_packages_start.sh"}
        - { src: "scripts/mavlink_shell.py", dest: "{{ drone_base_path }}/scripts/mavlink_shell.py"}
  
    - name: Chrony Tracking Check
      block: 
        - name: Copy script
          ansible.builtin.copy: 
            src: scripts/chronyc_check.py
            dest: /tmp/chronyc_check.py
            mode: '0755'
          
        - name: Check if we're tracking
          ansible.builtin.shell: /tmp/chronyc_check.py
          register: chronyc_check
          changed_when: false


    - name: Start ros_packages service
      ansible.builtin.systemd: 
        name: ros_packages
        state: started
        enabled: false
        daemon_reload: true
        scope: user
    
  


# TODO: Add something about waiting and checking all the packages after :)

