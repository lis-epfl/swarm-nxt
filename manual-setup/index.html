<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Manual Setup Instructions - SwarmNxt</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/custom.css" rel="stylesheet" />
        <link href="../css/terminal-player.css" rel="stylesheet" />
        <link href="../css/asciinema-player.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Manual Setup Instructions";
        var mkdocs_page_input_path = "manual-setup.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> SwarmNxt
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../infra-setup/">Infrastructure Setup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../drone-setup/">Drone Build Instructions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../remote-control-setup/">Remote Control Setup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../flying/">Flying</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../software-common-tasks/">Common Software Tasks</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Manual Setup Instructions</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#image-creation">Image Creation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#raw-image-setup">Raw Image Setup</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#password-free-access">Password-Free Access</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#run-ansible-playbook">Run Ansible Playbook</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#backups-and-restores">Backups and Restores</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#create-image-procedure">Create Image Procedure</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#restore-procedure">Restore Procedure</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#nxt-flight-controller-setup">NXT Flight Controller Setup</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#airframe">Airframe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#general-settings">General Settings</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#telemetry">Telemetry</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#power">Power</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#actuators">Actuators</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#safety-setup">Safety Setup</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ekf-setup">EKF Setup</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../appendix/">Appendix</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">SwarmNxt</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Manual Setup Instructions</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/lis-epfl/swarm-nxt/edit/main/docs/manual-setup.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="manual-setup">Manual Setup</h1>
<p>These instructions are for documentation purposes, normal users do not need to follow them. They show how the images or parameter files used in the other sections were made. This section will be useful if you want to understand how to make those assets and change something in the default settings that we've assumed. </p>
<h2 id="image-creation">Image Creation</h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You do not need to follow all of these steps if you are simply flashing a pre-made image. </p>
</div>
<h3 id="raw-image-setup">Raw Image Setup</h3>
<p>These steps describe how to build the intial image for the NVIDIA Orin board. These steps are only necessary if you want to rebuild the raw image. </p>
<ol>
<li>Ensure that the devkit is turned off and the power unplugged, but ready to be plugged in</li>
<li>Ensure that the devkit is connected to the host computer via the Recovery Port</li>
<li>Press the button labelled "REC" on the Devboard</li>
<li>While pressing the REC button, press the RES button</li>
<li>Release the RES button while still pressing the REC button</li>
<li>Connect the power to the Jetson, and release the REC button after the power is connected</li>
<li>On the host computer, run <code>lsusb</code>. This sequence was a success if an entry with NVIDIA Corp. APX is visible (<code>ID 0955:7323 NVIDIA Corp. APX</code>)</li>
</ol>
<p>Download the SDK Manager from the <a href="https://developer.nvidia.com/sdk-manager">NVIDIA Website</a>. Your computer should be running the same OS version as you would like to be installed on the Orin. If not, you can run it in docker. These instructions can be found on the NVIDIA SDK Manager page.  Then, run the following steps: </p>
<ol>
<li>Install the SDK Manager: <code>sudo dpkg -i /path/to/sdkmanager.deb</code>. If required, install any missing dependencies with <code>sudo apt --fix-broken install</code></li>
<li>Run the sdkmanager: <code>sdkmanager --cli</code></li>
<li>Login, and then select the following options: install -&gt; jetson -&gt; target hardare</li>
<li>The Orin NX should already be detected, select it. </li>
<li>Reply Y to showing all Jetson versions. Select JetPack 6.2</li>
<li>Additional SDKs: <!-- TODO: which ones? --></li>
<li>Customize install settings: Y</li>
<li>Select all the options by using the arrow keys and space to select, enter to continue</li>
<li>Reply Y to "Do you want to flash Jetson Orin NX module?". Select Pre-Config for OEM Config. </li>
<li>Username: lis, Password: orin</li>
<li>Choose NVME for the storage device</li>
<li>Wait for the installation to finish. </li>
<li>Select install when asked to install runtime components/SDK components</li>
<li>Select proxy mode</li>
<li>Select the IP that you want the device to have. This documentation assumes <code>192.168.55.1</code></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you get an error like "cannot stat /dev/nvme0n1", ensure that the flash storage is fully seated.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The raw image was created after these steps.</p>
</div>
<h3 id="password-free-access">Password-Free Access</h3>
<p>You must set this up before running the playbook below. See <a href="../software-common-tasks/#password-free-access">Password-Free Access</a></p>
<h3 id="run-ansible-playbook">Run Ansible Playbook</h3>
<p>We use <a href="https://www.redhat.com/en/ansible-collaborative">Ansible</a> to facilitate idempotent configuration. </p>
<p>Make sure Ansible is installed following the <a href="../infra-setup/#ansible-installation">setup instructions</a></p>
<p>Then, clone the <a href="https://github.com/lis-epfl/onix-nxt">repo</a>, and open a terminal in the ansible directory. To make the following process faster, download the patched-kernel tarball from the <a href="https://drive.google.com/drive/folders/1IpKJmJZyAb2P-46V7JcgBnGyn-WECAMc">Google Drive</a>. Place this file in a folder called <code>ansible/patched-kernel</code> inside the repo. </p>
<p>Ensure you are in the <code>ansible/</code> folder of the repository. Run <code>ansible-playbook -i inventory.ini drone_setup.yml -K</code>. It will ask you for a BECOME password. It is the root password of the orin (<code>orin</code>). There should be no failed steps.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The post install image was created after this step, with the hostname set to <code>ubuntu</code></p>
</div>
<h3 id="backups-and-restores">Backups and Restores</h3>
<p>Common: </p>
<ul>
<li>On the host computer with the NVIDIA SDK installed, navigate to <code>~/nvidia/nvidia_sdk/JetPack_6.2_Linux_JETSON_ORIN_NX_TARGETS/Linux_for_Tegra</code></li>
</ul>
<h4 id="create-image-procedure">Create Image Procedure</h4>
<ol>
<li>Prepare the device by installing what is required</li>
<li>Cleanup any log files and unnecessary files to make the image compact</li>
<li>Restart the device in recovery mode (follow the steps in <a href="#raw-image-setup">Raw Image Setup</a>)</li>
<li>Run <code>sudo ./tools/backup_restore/l4t_backup_restore.sh -e nvme0n1 -b jetson-orin-nano-devkit-nvme</code></li>
<li>Compress the image folder: <code>cd tools/backup_restore &amp;&amp; sudo tar -cvzf &lt;name&gt;.tar.gz images</code></li>
<li>Save the compressed image for restore later. </li>
</ol>
<h4 id="restore-procedure">Restore Procedure</h4>
<ol>
<li>Ensure that the image you want to restore is unzipped in tools/backup_restore/ (There should be a directory called <code>images</code> with various .img files inside)</li>
<li>Ensure you are in the <code>Linux_for_Tegra</code> folder. </li>
<li>Restart the device in recovery mode (follow the steps in <a href="#raw-image-setup">Raw Image Setup</a>)</li>
<li>Run <code>sudo ./tools/backup_restore/l4t_backup_restore.sh -e nvme0n1 -r jetson-orin-nano-devkit-nvme</code></li>
</ol>
<h2 id="nxt-flight-controller-setup">NXT Flight Controller Setup</h2>
<p>These steps were followed to create the parameter file described in <a href="../drone-setup/#post-flash-setup">Drone Setup</a>. This file only replaces the application of the parameter file part. You still must complete the rest of the setup described in the <a href="../drone-setup/#nxt-configuration-and-calibration">NXT Configuration and Calibration Section</a></p>
<h3 id="airframe">Airframe</h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You must do this first, since it will reset the other values.</p>
</div>
<p>Under airframe, select Quadcopter X, Generic Quadcopter. Click on apply and restart. </p>
<h3 id="general-settings">General Settings</h3>
<ul>
<li>If indoors, no GPS (assumed default)<ul>
<li><code>COM_ARM_WO_GPS</code>: Warning </li>
<li><code>COM_ARM_MAG_STR</code>: Warning</li>
<li><code>SYS_HAS_MAG</code>, <code>SYS_HAS_GPS</code>, <code>SYS_HAS_BARO</code>: Set to 0/Disabled. </li>
</ul>
</li>
<li><code>RC_PORT_CONFIG</code>: Radio Controller </li>
<li><code>IMU_GYRO_RATEMAX</code>: 2000Hz</li>
<li><code>IMU_INTEG_RATE</code>: 400Hz</li>
<li><code>MAV_0_MODE</code>: External Vision</li>
<li><code>MAV_0_RATE</code>: 92160 B/s</li>
</ul>
<h3 id="telemetry">Telemetry</h3>
<p>Set the following settings:</p>
<ul>
<li><code>MAV_0_CONFIG</code>: TELEM 2</li>
<li><code>SER_TEL2_BAUD</code>: 921600 8N1</li>
</ul>
<h3 id="power">Power</h3>
<p>Navigate to the power tab and fill in these settings: </p>
<ul>
<li>Source: Power Module</li>
</ul>
<p>Set the following items to match the battery you're using. We have provided the settings for the battery that we used: </p>
<ul>
<li>Set the number cells:  6 </li>
<li>Empty Voltage: 2.56V </li>
<li>Full Voltage: 4.05V</li>
</ul>
<h3 id="actuators">Actuators</h3>
<p>Open the MAVLink console (in the Analyze Tools menu accessible from the Q button on the main screen). Input the coordinates of the actuators. It is done this way since the Actuators tab truncates values to two decimal places. </p>
<pre><code>param set CA_ROTOR0_PX 0.0535
param set CA_ROTOR0_PY 0.0535

param set CA_ROTOR1_PX -0.0535
param set CA_ROTOR1_PY -0.0535

param set CA_ROTOR2_PX 0.0535
param set CA_ROTOR2_PY -0.0535

param set CA_ROTOR3_PX -0.0535
param set CA_ROTOR3_PY 0.0535
</code></pre>
<p>These positions are relative to the center of gravity of the drone, so ensure that the battery is placed such that the CoG is truly at the middle of the drone. Then, go back to the Vehicle Setup menu and open the Actuators tab. <strong>DO NOT TOUCH THE POSITION TEXTBOXES</strong> since the values will truncate to two decimal places. </p>
<h3 id="safety-setup">Safety Setup</h3>
<p>On the Safety tab: </p>
<ol>
<li>Set the battery failsafe to land mode</li>
<li>Set the RC loss failsafe to land mode</li>
<li>Set the geofence failsafe to land mode</li>
<li>Set the land mode speed to 0.3m/s and disarm after 7s. You will have to force save.</li>
</ol>
<p>On the parameters tab: </p>
<ol>
<li>Set <code>COM_OBL_RC_ACT</code> to Land Mode</li>
<li>Set <code>CBRK_SUPPLY_CHK</code> to 0. </li>
</ol>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you do not set the <code>CBRK_SUPPLY_CHK</code> to zero, none of the battery related checks will execute!</p>
</div>
<h3 id="ekf-setup">EKF Setup</h3>
<p>Set the following parameters in the Parameters screen: </p>
<table>
<thead>
<tr>
<th><strong>Parameter</strong></th>
<th><strong>Value</strong></th>
<th><strong>Notes</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>EKF2_ACC_NOISE</code></td>
<td>max_value (1.00)</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_ACC_B_NOISE</code></td>
<td>max_value (0.01)</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_GYR_NOISE</code></td>
<td>max_value (0.1)</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_GYR_B_NOISE</code></td>
<td>max_value (0.01)</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_EV_NOISE_MD</code></td>
<td>0.0</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_EVP_NOISE</code></td>
<td>0</td>
<td>Need to force save</td>
</tr>
<tr>
<td><code>EKF2_EVA_NOISE</code></td>
<td>0</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_EV_CTRL</code></td>
<td>11</td>
<td>Horizontal, Vertical, and Yaw should be checked</td>
</tr>
<tr>
<td><code>EKF2_HGT_REF</code></td>
<td>Vision</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_GPS_CTRL</code></td>
<td>0</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_BARO_CTRL</code></td>
<td>0</td>
<td></td>
</tr>
<tr>
<td><code>EKF2_RNG_CTRL</code></td>
<td>0</td>
<td></td>
</tr>
</tbody>
</table>
<p>Restart the drone by going to Tools &gt; Restart.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../software-common-tasks/" class="btn btn-neutral float-left" title="Common Software Tasks"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../appendix/" class="btn btn-neutral float-right" title="Appendix">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/lis-epfl/swarm-nxt" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../software-common-tasks/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../appendix/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../js/mathjax.js"></script>
      <script src="../js/copy-button.js"></script>
      <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../js/asciinema-player.min.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
